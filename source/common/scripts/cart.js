
let cart = {
  items: [
{
    "itemId": "ITM000000000001",
    "type": "product",
    "info": {
        "name": "Premium Wireless Earbuds",
        "image": "./localstore/images/items/amul-butter.jpg"
    },
    "pricing": {
        "price": 1299,
        "oldPrice": 2499,
        "discount": 48
    },
    "cart": {
        "qty": 1,
        "selectedDate": null,
        "subtotal": 1299
    },
    "rating": 4.5,
    "stock": {
        "status": "in",
        "label": "In stock"
    }
},
{
    "itemId": "ITM000000000002",
    "type": "product",
    "info": {
        "name": "Smart Fitness Tracker",
        "image": "./localstore/images/items/bread.jpg"
    },
    "pricing": {
        "price": 899,
        "oldPrice": 1599,
        "discount": 44
    },
    "cart": {
        "qty": 2,
        "selectedDate": null,
        "subtotal": 1798
    },
    "rating": 4.0,
    "stock": {
        "status": "limited",
        "label": "Only 3 left"
    }
},
{
    "itemId": "ITM000000000005",
    "type": "product",
    "info": {
        "name": "Wireless Bluetooth Speaker",
        "image": "./localstore/images/default-product.jpg"    },
    "pricing": {
        "price": 1999,
        "oldPrice": 2999,
        "discount": 33
    },
    "cart": {
        "qty": 1,
        "selectedDate": null,
        "subtotal": 1999
    },
    "rating": 4.7,
    "stock": {
        "status": "in",
        "label": "In stock"
    }
},
{
    "itemId": "ITM000000000006",
    "type": "product",
    "info": {
        "name": "Gaming Mouse",
        "image": "./localstore/images/default-product.jpg"    },
    "pricing": {
        "price": 799,
        "oldPrice": 1299,
        "discount": 38
    },
    "cart": {
        "qty": 1,
        "selectedDate": null,
        "subtotal": 799
    },
    "rating": 4.3,
    "stock": {
        "status": "in",
        "label": "In stock"
    }
},
{
    "itemId": "ITM000000000003",
    "type": "service",
    "info": {
        "name": "Professional Photography Session",
        "image": "./localstore/images/default-service.jpg"    },
    "pricing": {
        "price": 3500,
        "oldPrice": 5000,
        "discount": 30
    },
    "cart": {
        "qty": 1,
        "selectedDate": null,
        "subtotal": 3500
    },
    "rating": 4.9,
    "stock": {
        "status": "in",
        "label": "Available"
    }
},
{
    "itemId": "ITM000000000004",
    "type": "service",
    "info": {
        "name": "Home Cleaning Service",
        "image": "./localstore/images/default-service.jpg"    
      },
    "pricing": {
        "price": 1200,
        "oldPrice": 1800,
        "discount": 33
    },
    "cart": {
        "qty": 1,
        "selectedDate": null,
        "subtotal": 1200
    },
    "rating": 4.6,
    "stock": {
        "status": "in",
        "label": "Available"
    }
},
{
    "itemId": "ITM000000000007",
    "type": "service",
    "info": {
        "name": "Yoga & Wellness Session",
        "image": "./localstore/images/default-service.jpg"
          },
    "pricing": {
        "price": 1500,
        "oldPrice": 2500,
        "discount": 40
    },
    "cart": {
        "qty": 1,
        "selectedDate": null,
        "subtotal": 1500
    },
    "rating": 4.8,
    "stock": {
        "status": "in",
        "label": "Available"
    }
},
{
    "itemId": "ITM000000000008",
    "type": "service",
    "info": {
        "name": "Car Maintenance Service",
        "image": "./localstore/images/default-service.jpg"    },
    "pricing": {
        "price": 2500,
        "oldPrice": 4000,
        "discount": 38
    },
    "cart": {
        "qty": 1,
        "selectedDate": null,
        "subtotal": 2500
    },
    "rating": 4.5,
    "stock": {
        "status": "limited",
        "label": "Only 2 left"
    }
},
{
    "itemId": "ITM000000000009",
    "type": "product",
    "info": {
        "name": "Smartphone Stand",
        "image": "./localstore/images/default-product.jpg"    },
    "pricing": {
        "price": 499,
        "oldPrice": 799,
        "discount": 38
    },
    "cart": {
        "qty": 1,
        "selectedDate": null,
        "subtotal": 499
    },
    "rating": 4.2,
    "stock": {
        "status": "in",
        "label": "In stock"
    }
},
{
    "itemId": "ITM000000000010",
    "type": "product",
    "info": {
        "name": "Laptop Cooling Pad",
        "image": "./localstore/images/default-product.jpg"    },
    "pricing": {
        "price": 999,
        "oldPrice": 1499,
        "discount": 33
    },
    "cart": {
        "qty": 1,
        "selectedDate": null,
        "subtotal": 999
    },
    "rating": 4.3,
    "stock": {
        "status": "in",
        "label": "In stock"
    }
},
{
    "itemId": "ITM000000000011",
    "type": "product",
    "info": {
        "name": "Wireless Keyboard",
        "image": "./localstore/images/default-product.jpg"    },
    "pricing": {
        "price": 1299,
        "oldPrice": 1999,
        "discount": 35
    },
    "cart": {
        "qty": 1,
        "selectedDate": null,
        "subtotal": 1299
    },
    "rating": 4.5,
    "stock": {
        "status": "limited",
        "label": "Only 4 left"
    }
},
{
    "itemId": "ITM000000000012",
    "type": "product",
    "info": {
        "name": "Portable Charger",
        "image": "./localstore/images/default-product.jpg"    },
    "pricing": {
        "price": 699,
        "oldPrice": 1099,
        "discount": 36
    },
    "cart": {
        "qty": 1,
        "selectedDate": null,
        "subtotal": 699
    },
    "rating": 4.4,
    "stock": {
        "status": "in",
        "label": "In stock"
    }
},
{
    "itemId": "ITM000000000013",
    "type": "service",
    "info": {
        "name": "Gardening Service",
        "image": "./localstore/images/default-service.jpg"    },
    "pricing": {
        "price": 1800,
        "oldPrice": 2800,
        "discount": 36
    },
    "cart": {
        "qty": 1,
        "selectedDate": null,
        "subtotal": 1800
    },
    "rating": 4.6,
    "stock": {
        "status": "in",
        "label": "Available"
    }
},
{
    "itemId": "ITM000000000014",
    "type": "service",
    "info": {
        "name": "Personal Training Session",
        "image": "./localstore/images/default-service.jpg"    },
    "pricing": {
        "price": 2000,
        "oldPrice": 3000,
        "discount": 33
    },
    "cart": {
        "qty": 1,
        "selectedDate": null,
        "subtotal": 2000
    },
    "rating": 4.7,
    "stock": {
        "status": "in",
        "label": "Available"
    }
},
{
    "itemId": "ITM000000000015",
    "type": "service",
    "info": {
        "name": "Dog Walking Service",
        "image": "./localstore/images/default-service.jpg"    },
    "pricing": {
        "price": 1200,
        "oldPrice": 1800,
        "discount": 33
    },
    "cart": {
        "qty": 1,
        "selectedDate": null,
        "subtotal": 1200
    },
    "rating": 4.5,
    "stock": {
        "status": "limited",
        "label": "Only 2 left"
    }
},
{
    "itemId": "ITM000000000016",
    "type": "service",
    "info": {
        "name": "House Painting Service",
        "image": "./localstore/images/default-service.jpg"    },
    "pricing": {
        "price": 5000,
        "oldPrice": 7000,
        "discount": 29
    },
    "cart": {
        "qty": 1,
        "selectedDate": null,
        "subtotal": 5000
    },
    "rating": 4.8,
    "stock": {
        "status": "in",
        "label": "Available"
    }
}
  ]
};

let activeTab = "products"; // products or services

// ⭐ Render Stars
function renderStars(rating) {
  let fullStars = Math.floor(rating);
  let halfStar = rating % 1 >= 0.5;
  let starsHtml = "";
  for (let i = 1; i <= 5; i++) {
    if (i <= fullStars) starsHtml += `<span class="filled">★</span>`;
    else if (i === fullStars + 1 && halfStar) starsHtml += `<span class="half">★</span>`;
    else starsHtml += `<span>★</span>`;
  }
  return `<div class="stars">${starsHtml} <small>(${rating.toFixed(1)})</small></div>`;
}

// ⭐ Render Cart
function rendercard() {
  const productsPanel = document.getElementById("products-tab-panel");
  const servicesPanel = document.getElementById("services-tab-panel");
  productsPanel.innerHTML = "";
  servicesPanel.innerHTML = "";

  let total = 0;
  const data = cart.items.filter(item => item.type === activeTab.slice(0, -1)); // "products" -> "product"

  const cartItemTemplate = document.getElementById("cart-item-template");

  data.forEach(item => {
    // Calculate subtotal
    item.cart.subtotal = item.pricing.price * item.cart.qty;
    total += item.cart.subtotal;

    // Stock CSS
    let stockStatusClass = "";
    let stockIconClass = "";
    switch (item.stock.status) {
      case "in":
        stockStatusClass = "in";
        stockIconClass = "fas fa-check-circle";
        break;
      case "limited":
        stockStatusClass = "in";
        stockIconClass = "fas fa-exclamation-circle";
        break;
      default:
        stockStatusClass = "out";
        stockIconClass = "fas fa-times-circle";
    }

    // Clone template
    const cardItem = document.importNode(cartItemTemplate.content, true);
    cardItem.querySelector(".card-title").textContent = item.info.name;
    cardItem.querySelector(".card-price").textContent = `₹${item.cart.subtotal}`;
    cardItem.querySelector(".card-old-price").textContent = `₹${item.pricing.oldPrice}`;
    cardItem.querySelector(".card-discount").textContent = `${item.pricing.discount}% off`;
    cardItem.querySelector(".stars").innerHTML = renderStars(item.rating);

    const stockStatusElement = cardItem.querySelector(".stock-status");
    stockStatusElement.classList.add(stockStatusClass);
    stockStatusElement.querySelector("i").className = stockIconClass;
    stockStatusElement.lastChild.textContent = ` ${item.stock.label}`;

    cardItem.querySelector(".card-top-area img").src = item.info.image;
    cardItem.querySelector(".card-top-area img").alt = item.info.name;

    cardItem.querySelector(".action-button").textContent =
      item.type === "product" ? "Request" : "Request";

    const container = cardItem.querySelector(".quantity-or-date-selector");
    if (item.type === "service") {
      const dateSelectorTemplate = document.getElementById("date-selector-template");
      const dateSelector = document.importNode(dateSelectorTemplate.content, true);
      dateSelector.querySelector(".date-text").id = `date-text-${item.itemId}`;
      dateSelector.querySelector(".date-text").textContent = item.cart.selectedDate || "Select Date";
      dateSelector.querySelector(".date-input").onchange = (e) => updateDate(item.itemId, e.target.value);
      container.appendChild(dateSelector);
    } else {
      const quantitySelectorTemplate = document.getElementById("quantity-selector-template");
      const quantitySelector = document.importNode(quantitySelectorTemplate.content, true);
      const selectElement = quantitySelector.querySelector(".quantity-input");
      selectElement.onchange = (e) => updateQty(item.itemId, e.target.value);
      for (let q = 1; q <= 5; q++) {
        const option = document.createElement("option");
        option.value = q;
        option.textContent = q;
        if (q == item.cart.qty) {
          option.selected = true;
        }
        selectElement.appendChild(option);
      }
      container.appendChild(quantitySelector);
    }

    cardItem.querySelector(".remove-item-button").onclick = () => removeItem(item.itemId);

    if (item.type === "product") productsPanel.appendChild(cardItem);
    else servicesPanel.appendChild(cardItem);
  });

  document.getElementById("cardTotal").innerText = total;
  document.querySelector(".btn-order").innerText =
    activeTab === "products" ? "Request All" : "Request All";
}

// ⭐ Update Qty
window.updateQty = function(itemId, qty) {
  const item = cart.items.find(i => i.itemId === itemId && i.type === "product");
  if (item) item.cart.qty = parseInt(qty);
  rendercard();
};

// ⭐ Update Date
window.updateDate = function(itemId, dateValue) {
  const item = cart.items.find(i => i.itemId === itemId && i.type === "service");
  if (item) {
    item.cart.selectedDate = dateValue;
    document.getElementById(`date-text-${itemId}`).textContent = dateValue || "Select Date";
  }
};

// ⭐ Remove Item
window.removeItem = function(itemId) {
  cart.items = cart.items.filter(i => i.itemId !== itemId);
  rendercard();
};

// ⭐ Switch Tab
window.switchTab = function(tab) {
  activeTab = tab;
  document.getElementById("tabProducts").classList.remove("active");
  document.getElementById("tabServices").classList.remove("active");
  document.getElementById("products-tab-panel").classList.remove("active");
  document.getElementById("services-tab-panel").classList.remove("active");

  if (tab === "products") {
    document.getElementById("tabProducts").classList.add("active");
    document.getElementById("products-tab-panel").classList.add("active");
  } else {
    document.getElementById("tabServices").classList.add("active");
    document.getElementById("services-tab-panel").classList.add("active");
  }
  rendercard();
};

// ⭐ Swipe Tabs
const tabPanels = document.querySelector(".cart-container");
let touchstartX = 0, touchstartY = 0;
let touchendX = 0, touchendY = 0;

const swipeThreshold = 30; // Minimum pixels for a swipe
const verticalThreshold = 30; // Maximum vertical deviation for a horizontal swipe

function handleGesture() {
  const diffX = touchendX - touchstartX;
  const diffY = touchendY - touchstartY;

  // Check if it's primarily a horizontal swipe and exceeds threshold
  if (Math.abs(diffX) > swipeThreshold && Math.abs(diffY) < verticalThreshold) {
    if (diffX < 0 && activeTab === "products") {
      switchTab("services");
    } else if (diffX > 0 && activeTab === "services") {
      switchTab("products");
    }
  }
}

tabPanels.addEventListener("touchstart", e => {
  touchstartX = e.changedTouches[0].screenX;
  touchstartY = e.changedTouches[0].screenY;
}, { passive: true });

tabPanels.addEventListener("touchmove", e => {
  // We don't prevent default here to allow normal scrolling
  // unless a clear horizontal swipe is detected later.
  // This listener is primarily to update touchendX/Y for gesture calculation.
  touchendX = e.changedTouches[0].screenX;
  touchendY = e.changedTouches[0].screenY;
});

tabPanels.addEventListener("touchend", handleGesture);

// Init
rendercard();

export function init() { rendercard(); }