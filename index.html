<!DOCTYPE html>
<html lang="hi"> 
<head>
  <!-- Set theme color for browser UI -->
  <meta charset="UTF-8"/>
  <!-- Dynamic Base URL for GitHub Pages (Adaptive) -->
  <base href="/apnastore.com/"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mStore - Online Marketplace</title>
  <link rel="icon" href="./source/assets/logos/app-logo.png" type="image/jpeg">
  <link rel="manifest" href="./manifest.json">
  <link rel="stylesheet" href="./source/common/styles/theme.css" />
    <link rel="stylesheet" href="./source/main.css" />
  <!-- Set theme color for browser UI -->
  <meta name="theme-color" id="theme-color-meta" content="#121212">
  <script>
    // This inline script runs before rendering to prevent a "flash of unstyled content" (FOUC).
    // It sets the theme class on the <html> element and updates the theme-color meta tag.
    (function() {
      const preference = localStorage.getItem('app-theme');
      const systemIsDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = preference || (systemIsDark ? 'dark' : 'light');
      
      document.documentElement.classList.add(`${theme}-mode`);
      document.documentElement.dataset.theme = theme;

      // Define theme colors to avoid waiting for CSS. These must match --bg-primary in main.css.
      const themeColors = {
        light: '#f9f9f9',
        dark: '#121212'
      };

      // Update the meta tag immediately to ensure the status bar color is correct on initial load.
      const themeColorMeta = document.getElementById('theme-color-meta');
      if (themeColorMeta) {
        themeColorMeta.setAttribute('content', themeColors[theme]);
      }
    })();
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
 </head>
 <body id="main-body">
  <div class="splash-screen" id="splashScreen">
    <div class="splash-content">
      <img src="./source/assets/logos/app-logo.png" 
           class="splash-logo" 
           alt="mStore Logo"
           onerror="this.src='./source/assets/logos/app-logo.png'">
      <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
      </div>
    </div>
  </div>
 
 <!-- Page Loader -->
 <div class="page-loader hidden">
  <div class="spinner"></div>
</div>

<!-- Header Partial -->
<header id="main-header-placeholder"></header>

<!-- Drawer Partial -->
<aside id="drawer-placeholder"></aside>  

<div id="pullToRefresh">
    <!-- Arrow icon -->
    <span class="material-icons" id="arrowIcon">refresh</span>
    <!-- Spinner icon (hidden by default) -->
    <span class="material-icons" id="spinnerIcon" style="display:none;">autorenew</span>
  </div>



<!-- Page Main Content -->
<main id="page-view-area"></main>
<!-- Dev Mode Switcher (should be last) -->
<div id="role-switcher-placeholder"></div>

<!-- Bottom Navigation Partial (should be last for stacking context) -->
<nav id="bottom-nav-placeholder"></nav>

  <!-- 8. Scripts -->
  <!-- This single module is the main entry point for the application's logic. -->
  <!-- It handles loading all other necessary components and scripts in the correct order. -->
<script>
    const progressBar = document.getElementById('progressBar');
    const splashScreen = document.getElementById('splashScreen');
    // Progress bar animation will be controlled by main.js
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script type="module">
  // ‚úÖ Import critical modules at the top.
  import { APP_CONFIG } from './source/utils/app-config.js';
  import { initializePwaInstall, setDeferredPrompt, getDeferredPrompt } from './source/utils/pwa-manager.js';
    import './source/firebase/firebase-config.js';
  // Import the main app initializer, but don't run it yet.
  import { initializeApp } from './source/main.js';

  // Log the current configuration for easy debugging.
  if (APP_CONFIG.appMode) {
    console.log(`%cüöÄ App Mode: ${APP_CONFIG.appMode.toUpperCase()}`, 'color: #448aff; font-weight: bold; font-size: 12px;');
  } else {
    console.log(`%cüöÄ App Mode: PRODUCTION`, 'color: #4caf50; font-weight: bold; font-size: 12px;');
  }
  console.log(`%cüíæ Data Source: ${APP_CONFIG.dataSource.toUpperCase()}`, 'color: #ff9800; font-weight: bold; font-size: 12px;');
  console.log(`%cüîí Verification Flow: ${APP_CONFIG.verificationEnabled ? 'ENABLED' : 'DISABLED'}`, 'color: #e91e63; font-weight: bold; font-size: 12px;');
  console.log(`%cüé® Header Style: ${APP_CONFIG.headerStyle.toUpperCase()}`, 'color: #9c27b0; font-weight: bold; font-size: 12px;');

    // --- PWA Install Prompt Handling ---
    // This listener captures the event that allows the app to be installed.
    // It prevents the default browser prompt and saves the event for later use.
    window.addEventListener('beforeinstallprompt', (e) => {
      // Prevent the mini-infobar from appearing on mobile
      e.preventDefault();
      // Stash the event so it can be triggered later.
      setDeferredPrompt(e);
      // Dispatch a custom event to notify UI components that the app is installable.
      // This is better than directly manipulating the DOM from here.
      window.dispatchEvent(new CustomEvent('pwaInstallReady'));
      console.log('`beforeinstallprompt` event was fired and captured.');
    });
    // --- Service Worker Management ---

  if ('serviceWorker' in navigator) {
    // This flag can be manually set to true in the console for PWA testing in dev mode.
    const forceSWInDev = true;

    const register = () => {
      if (APP_CONFIG.appMode === 'dev' && forceSWInDev) {
      }
      // Register the service worker as a module to allow 'import' statements inside it.
      navigator.serviceWorker.register('./service-worker.js', { type: 'module' })
        .then(registration => console.log('‚úÖ Service Worker registered successfully:', registration))
        .catch(error => console.error('‚ùå Service Worker registration failed:', error, 'Ensure the service worker file is served with the correct MIME type (application/javascript or text/javascript) and not text/html.'));
    };

    const unregister = () => {
      console.log('DEV MODE: Unregistering all service workers.');
      navigator.serviceWorker.getRegistrations().then(registrations => {
        for (let registration of registrations) {
          registration.unregister();
        }
      });
    };

    (APP_CONFIG.appMode === 'dev' && !forceSWInDev) ? unregister() : register();
  } else {
    console.warn('Service Worker not supported in this browser.');
  }


  // 2. Initialize the main application.
  initializeApp()
    .then(() => {
      console.log("‚úÖ Application initialized successfully.");
    })
    .catch(error => {
      // This is a critical error. The app cannot start.
      console.error("‚ùå CRITICAL: Failed to load essential app components. App cannot start.", error);
      document.body.innerHTML = `<div style="padding: 40px 20px; text-align: center; font-family: sans-serif; color: #333;"><h1 style="color: #d9534f;">Application Error</h1><p>The application could not be started due to a critical error.</p><p>Please try refreshing the page. If the problem persists, check the browser console for details.</p></div>`;
    });
</script>
</body>
</html>
